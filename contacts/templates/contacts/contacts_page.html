{% extends "base.html" %}

<!-- load wagtailcore_tags by adding this: -->
{% load wagtailcore_tags %}
{% load wagtailimages_tags %}

<!-- replace everything below with: -->
{% block content %}

<div class="container mt-5">
  <div class="row">
    <div class="col-12">
      <h2>{{self.subtitle}}</h2>
    </div>

    <div class="text-success">
      <hr class="border border-primary border-2">
    </div>
  </div>
  <div class="row">
    <div class="mb-5 col-12 col-lg-6">
      <p>{{self.body|richtext}}</p>
    </div>
    <div class="mb-5 col-12 col-lg-6">
      <form action="{% pageurl page %}" method="POST">
        {% csrf_token %}
        {% for field in form.visible_fields %}
       <div class="form-group mb-10">
           {% if field.field.widget.input_type %}
             <div class="mb-3">
               <label for="exampleInputEmail1" class="form-label">{{ field.label|safe }}</label>
               <input
                    type="{{field.widget.input_type}}"
                    name="{{ field.name }}"
                    class="form-control"
                    id="{{ field.id_for_label }}"
                    {% if field.field.required %}required="required"{% endif %}
                    aria-describedby="{{ field.id_for_label }}">
             </div>
           {% else %}
             <div class="mb-3">
               <label for="{{ field.id_for_label }}" class="form-label">{{ field.label|safe }}</label>
               <textarea
                    type="{{field.widget.input_type}}"
                    name="{{ field.name }}"
                    class="form-control"
                    id="{{ field.id_for_label }}"
                    {% if field.field.required %}required="required"{% endif %}
                    aria-describedby="{{ field.id_for_label }}"></textarea>
             </div>
           {% endif %}
         </div>
         {% endfor %}
         <button type="submit" class="btn btn-primary">Submit</button>
      </form>
    </div>
  </div>
  <div class="row">
    <div class="col-12">
      <h4>Regional offices</h4>
    </div>
    <div id="map" class="col-md-6 col-12" style="height:400px;">

    </div>
    <div class="col-12 col-md-6">
      <div class="list-group">
        {% for office in self.offices %}
          <div class="list-group-item list-group-item-action flex-column align-items-start">
            <div class="d-flex w-100 justify-content-between">
              <h5 class="mb-1">{{office.value.office_name}}</h5>
              <small>{{office.value.office_province}}</small>
            </div>
            <p class="mb-1">{{office.value.office_location}}</p>
            <p class="mb-1">{{office.value.office_phone}}</p>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoibGVuc2VnIiwiYSI6ImNpbm8ydWdnbzEwM2h1a20zanU5dTRmd2IifQ.HJplRyZIckK5LQLTgj5WAA';
      const map = new mapboxgl.Map({
      container: 'map', // container ID
      style: 'mapbox://styles/mapbox/streets-v12', // style URL
      center: [158.797190, -8.901858], // starting position [lng, lat]
      zoom: 5, // starting zoom
    });
    fetch('/api/v2/pages/7/')
      .then(response => response.json())
      .then(data => {
        console.log(data)
        for (const office of data.offices) {
          const el = document.createElement('div');
          el.className = 'marker';
          const popup = new mapboxgl.Popup({ offset: 25 }).setHTML(
            `<h6 class="mb-1">${office.value.office_name}</h6> <p class="mb-1">${office.value.office_location}</p> \n <p class="mb-1">${office.value.office_phone}</p>`
          );
          new mapboxgl.Marker(el,{
            offset: [0, -15]
          }).setLngLat({
            lng: parseFloat(office.value.lng),
            lat: parseFloat(office.value.lat)
          }).setPopup(popup).addTo(map);
        }
      })

  </script>
</div>
{% endblock %}
